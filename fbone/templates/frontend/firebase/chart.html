<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.js"></script>
        <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
        <script src="https://code.highcharts.com/stock/highstock.js"></script>
        <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>

    </head>

    <body>
        <div id="container" style="height: 400px; min-width: 310px"></div>
        <script>
            var username = "{{ user }}"
            var firebase = new Firebase('https://ryan.firebaseio.com/')
            user = firebase.child('heart_rate/' + username)
            user.once("value", function(snapshot) {
                var hearBeatData = [];
                snapshot.forEach(function(childSnapshot) {
                    var key = childSnapshot.key()
                    var value = childSnapshot.val()
                    hearBeatData.push([parseInt(key), value])
                });
                makeChart(username, hearBeatData);
            }, function (errorObject) {
                console.log("The read failed: " + errorObject.code)
            });

            function getUserRef(name) {
                return firebase.child('heart_rate/' + name)
            }

            function makeChart(user, data) {
                var ref = getUserRef(user);
                $('#container').highcharts('StockChart', {
                    chart : {
                        events : {
                            load : function () {
                                var series = this.series[0]
                                var startKey = new Date().getTime().toString()
                                ref.orderByKey().startAt(startKey).on("child_added", function(snapshot) {
                                    var key = parseInt(snapshot.key());
                                    var value = snapshot.val();
                                    series.addPoint([key, value, true, true])
                                })
                            }
                        }
                    },

                    rangeSelector : {selected : 1},

                    title : {text : 'Heart Rate'},

                    series : [{
                        name : 'Heart Rate',
                        data : data,
                        type: 'spline',
                        tooltip: {
                            valueDecimals: 2
                        }
                    }]
                })
            }

            function insertData(user, fromDate, numEntries) {
                var ref = getUserRef(user);
                for(var i = 0; i < numEntries; i++) { 
                    ref.child(fromDate.getTime()).set(Math.floor(Math.random() * 80) + 60)
                    // Increase minutes by 1
                    fromDate.setMinutes(fromDate.getMinutes() + 1)
                }
            }

        </script>
    </body>
</html>